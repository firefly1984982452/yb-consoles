import _ from 'lodash'
import store from '../store'
import router from '../router'
import settings from '../settings'
import https from './https'

const _install = function (Vue, opts = {}) {
  if(_install.installed) {
    return;
  }
  _install.installed = true;
  if(!opts) {
    opts = {};
  }
  if (opts.settings) {
    _.merge(settings, opts.settings);
    _.merge(opts.settings, settings);
  } else {
    opts.settings = settings;
  }
  // 注入router、store等
  store.install(Vue, opts);
  router.install(Vue, opts);
  https.install(Vue, opts);
};

const create = function (Vue, opts = {}) {
  _install(Vue, opts);
  // 在创建全局Vue实例前，尝试获取当前登录用户（用户后续判断是否登录）
  if (!opts || !opts.withoutUser) {
    (async () => {
      await https.fetchCurrentUser();
      new Vue(opts);
    })();
  } else {
    new Vue(opts);
  }
};

const install = function(Vue, opts = {}) {
  Vue.create = function (options) {
    create(Vue, options);
  };
  /* Vue.mixin({
    beforeCreate() {
      if (this.constructor.name === 'Vue' && !this.$store) {
        this.$store = opts.store;
      }
    }
  }); */
};

export default {
  install
}
